<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= movie.title %> | Book Tickets</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <style>
      /* Page specific overrides if needed, mostly moved to style.css */
      .booking-header {
          border-bottom: 1px solid #333;
          padding-bottom: 20px;
          margin-bottom: 20px;
      }
      .details-row {
          color: #aaa;
          font-size: 0.9rem;
          margin-bottom: 20px;
      }
      .details-row span {
          margin-right: 15px;
      }
      .details-row i {
          color: #E50914;
          margin-right: 5px;
      }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <div class="netflix-navbar">
      <div class="logo">ticketBook</div>
      <div class="nav-right">
          <a href="/home" style="color: #fff; font-weight: bold;">Home</a>
          <a href="/profile" style="color: #fff;">My Tickets</a>
      </div>
  </div>

  <div class="container booking-container">
    <div class="row" style="display: flex; flex-wrap: wrap; gap: 30px; justify-content: center;">
      
      <!-- Poster Column -->
      <div style="flex: 1; min-width: 300px; max-width: 350px;">
        <img src="<%= movie.image %>" alt="<%= movie.title %>" class="movie-poster-large">
      </div>

      <!-- Booking Form Column -->
      <div style="flex: 2; min-width: 300px;">
        <div class="booking-panel">
          
          <div class="booking-header">
              <h1 style="color: white; margin-bottom: 10px;"><%= movie.title %></h1>
              <div class="details-row">
                  <span><i class="far fa-clock"></i> <%= movie.duration %> min</span>
                  <span><i class="fas fa-language"></i> <%= movie.language %></span>
                  <span><i class="far fa-calendar-alt"></i> <%= movie.releaseDate ? new Date(movie.releaseDate).getFullYear() : 'N/A' %></span>
              </div>
              <p style="color: #ccc; line-height: 1.5;"><%= movie.description %></p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- City Selection -->
            <div>
              <label style="color: #aaa; display: block; margin-bottom: 8px;">Select City</label>
              <select id="city" class="form-select-dark">
                <option value="">-- Choose City --</option>
                <option value="Ahmedabad">Ahmedabad</option>
                <option value="Surat">Surat</option>
                <option value="Vadodara">Vadodara</option>
                <option value="Pune">Pune</option>
                <option value="Mumbai">Mumbai</option>
                <option value="Delhi">Delhi</option>
                <option value="Bangalore">Bangalore</option>
              </select>
            </div>

            <!-- Show Selection -->
            <div>
              <label style="color: #aaa; display: block; margin-bottom: 8px;">Show Time</label>
              <% if (shows && shows.length > 0) { %>
                <select id="showSelect" class="form-select-dark">
                  <option value="">-- Choose Show --</option>
                  <% shows.forEach(show => { %>
                    <option value="<%= show._id %>"><%= show.time %> (â‚¹<%= show.price %>)</option>
                  <% }) %>
                </select>
              <% } else { %>
                <div style="color: #E50914; margin-top: 10px;">No shows available.</div>
              <% } %>
            </div>
          </div>

          <!-- Seat Selection -->
          <div style="margin-top: 30px;">
            <label style="color: #fff; font-weight: bold; margin-bottom: 15px; display: block;">Select Seats</label>
            
            <div class="seat-grid">
              <% for(let i = 1; i <= 32; i++) { %>
                <div class="seat"><%= i %></div>
              <% } %>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 20px;">
              <div class="legend-item">
                  <div class="legend-box" style="background: #444;"></div> Available
              </div>
              <div class="legend-item">
                  <div class="legend-box" style="background: #E50914;"></div> Selected
              </div>
              <div class="legend-item">
                  <div class="legend-box" style="background: #222; text-decoration: line-through;"></div> Booked
              </div>
            </div>
          </div>

          <!-- Submit -->
          <button id="bookBtn" class="btn-submit" style="margin-top: 30px;">
              Confirm Booking
          </button>

        </div>
      </div>
    </div>
  </div>

  <script>
    let selectedShowId = "";
    const showSelect = document.getElementById("showSelect");

    // Fetch and mark booked seats
    async function updateSeats() {
      // Reset all seats first
      document.querySelectorAll(".seat").forEach(seat => {
          seat.classList.remove("selected", "booked");
          seat.style.pointerEvents = "auto";
          seat.title = "Available";
      });

      if (!selectedShowId) return;

      try {
          const res = await fetch(`/api/booked-seats/${selectedShowId}`);
          const data = await res.json();
          
          if (data.success && data.bookedSeats) {
              data.bookedSeats.forEach(seatNum => {
                  const seatEl = [...document.querySelectorAll(".seat")].find(el => el.innerText == seatNum);
                  if (seatEl) {
                      seatEl.classList.add("booked");
                      seatEl.title = "Booked";
                  }
              });
          }
      } catch (err) {
          console.error("Error fetching booked seats:", err);
      }
    }

    if (showSelect) {
      showSelect.addEventListener("change", function () {
        selectedShowId = this.value;
        updateSeats();
      });
    }

    document.querySelectorAll(".seat").forEach(seat => {
      seat.addEventListener("click", () => {
        if (!seat.classList.contains("booked")) {
            seat.classList.toggle("selected");
        }
      });
    });

    document.getElementById("bookBtn").addEventListener("click", async () => {
      const city = document.getElementById("city").value;
      const seats = [...document.querySelectorAll(".seat.selected")].map(s => s.innerText);

      if (!city) {
          alert("Please select a city.");
          return;
      }
      if (!selectedShowId) {
          alert("Please select a show time.");
          return;
      }
      if (seats.length === 0) {
          alert("Please select at least one seat.");
          return;
      }

      const btn = document.getElementById("bookBtn");
      const originalText = btn.innerText;
      btn.innerText = "Processing...";
      btn.disabled = true;

      try {
        const res = await fetch("/book-ticket", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            city,
            showId: selectedShowId,
            seats,
            movieId: "<%= movie._id %>"
          })
        });

        const data = await res.json();

        if (data.success) {
           window.location.href = "/profile/ticket"; 
        } else {
          alert("Booking Failed: " + (data.message || "Unknown error"));
          if (data.redirect) {
              window.location.href = data.redirect;
          } else {
              updateSeats();
          }
          btn.innerText = originalText;
          btn.disabled = false;
        }
      } catch (err) {
        console.error(err);
        alert("Something went wrong");
        btn.innerText = originalText;
        btn.disabled = false;
      }
    });
  </script>

</body>
</html>